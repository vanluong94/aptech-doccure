<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	  xmlns:th="https://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{layout}"
>
<head>
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB41DRUbKWJHPxaFjMAwdrzWzbVKartNGg&callback=initMap&v=weekly" defer></script>
	<style>
		#clinic_location_map {
			width: 980px;
			height: 500px;
		}
		.dropzone {
			padding: 5em 2em;
		}

		.dropzone > input[type="file"] {
			position: absolute;
			top: 0;
			right: 0;
			bottom: 0;
			left: 0;
			cursor: pointer;
			/* opacity: 0; */
		}

		.dropzone .dropzone-message {
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
		}
	</style>
</head>
<body>
	<div class="page-content" layout:fragment="layoutContent">
		<!-- Breadcrumb -->
		<div class="breadcrumb-bar">
			<div class="container-fluid">
				<div class="row align-items-center">
					<div class="col-md-12 col-12">
						<nav aria-label="breadcrumb" class="page-breadcrumb">
							<ol class="breadcrumb">
								<li class="breadcrumb-item"><a th:href="@{/}">Home</a></li>
								<li class="breadcrumb-item active" aria-current="page">Dashboard</li>
							</ol>
						</nav>
						<h2 class="breadcrumb-title">Dashboard</h2>
					</div>
				</div>
			</div>
		</div>
		<!-- /Breadcrumb -->

		<!-- Page Content -->
		<div class="content">
			<div class="container-fluid">
				<div class="row">
				<div class="col-md-5 col-lg-4 col-xl-3 theiaStickySidebar">

					<div th:replace="fragments/dashboard/doctorSidebar :: sidebar"></div>

				</div>
				<div class="col-md-7 col-lg-8 col-xl-9">
				<div class="alert alert-success" th:if="${successMessage}" th:text="${successMessage}"></div>
				<div class="alert alert-danger" th:if="${errorMessage}" th:text="${errorMessage}"></div>
				<form id="doctorProfileForm" action="#" method="post" th:action="@{/dashboard/profile-settings}" th:object="${doctor}" enctype="multipart/form-data">
					<div th:if="${#fields.hasAnyErrors()}">
						<ul>
							<li th:each="err : ${#fields.allErrors()}" th:text="${err}"></li>
						</ul>
					</div>
					<input type="hidden" th:field="*{id}">
					<input type="hidden" th:field="*{avatar}">
					<!-- Basic Information -->
					<div class="card">
						<div class="card-body">
							<h4 class="card-title">Basic Information</h4>
							<div class="row form-row">
								<div class="col-md-12">
									<div class="form-group">
										<div class="change-avatar">
											<div class="profile-img">
												<img src="#" th:src="${doctor.theAvatar}" alt="User Image">
											</div>
											<div class="upload-img">
												<div class="change-photo-btn">
													<span><i class="fa fa-upload"></i> Upload Photo</span>
													<input type="file" th:field="*{avatarMultipartFile}" class="upload" accept=".jpg,.jpeg,.png">
												</div>
												<small class="form-text text-muted">Allowed JPG, GIF or PNG. Max size of 2MB</small>
												<p th:if="${#fields.hasErrors('avatarMultipartFile')}" th:errors="*{avatarMultipartFile}" class="invalid-feedback"></p>
											</div>
										</div>
									</div>
								</div>
								<div class="col-md-6">
									<div class="form-group">
										<label>Username <span class="text-danger">*</span></label>
										<input type="text" class="form-control" th:field="*{username}" readonly>
									</div>
								</div>
								<div class="col-md-6">
									<div class="form-group">
										<label>Email <span class="text-danger">*</span></label>
										<input type="email" class="form-control" th:field="*{email}" readonly>
									</div>
								</div>
								<div class="col-md-6">
									<div class="form-group">
										<label>First Name <span class="text-danger">*</span></label>
										<input type="text" class="form-control" th:field="*{firstName}">
										<p th:if="${#fields.hasErrors('firstName')}" th:errors="*{firstName}" class="invalid-feedback"></p>
									</div>
								</div>
								<div class="col-md-6">
									<div class="form-group">
										<label>Last Name <span class="text-danger">*</span></label>
										<input type="text" class="form-control" th:field="*{lastName}">
										<p th:if="${#fields.hasErrors('lastName')}" th:errors="*{lastName}" class="invalid-feedback"></p>
									</div>
								</div>
								<div class="col-md-6">
									<div class="form-group">
										<label>Phone Number</label>
										<input type="text" class="form-control" th:field="*{phone}">
										<p th:if="${#fields.hasErrors('phone')}" th:errors="*{phone}" class="invalid-feedback"></p>
									</div>
								</div>
								<div class="col-md-6">
									<div class="form-group">
										<label>Gender</label>
										<select class="form-control select" th:field="*{gender}">
											<option value="">Select</option>
											<option value="0">Male</option>
											<option value="1">Female</option>
										</select>
									</div>
								</div>
								<div class="col-md-6">
									<div class="form-group mb-0">
										<label>Date of Birth</label>
										<input type="date" class="form-control" th:field="*{dob}">
										<p th:if="${#fields.hasErrors('dob')}" th:errors="*{dob}" class="invalid-feedback"></p>
									</div>
								</div>
							</div>
						</div>
					</div>
					<!-- /Basic Information -->

					<!-- About Me -->
					<div class="card">
						<div class="card-body">
							<h4 class="card-title">About Me</h4>
							<div class="form-group mb-0">
								<label>Biography</label>
								<textarea class="form-control" rows="5" th:field="*{bio.biography}"></textarea>
							</div>
						</div>
					</div>
					<!-- /About Me -->

					<!-- Clinic Info -->
					<div class="card">
						<div class="card-body">
							<h4 class="card-title">Clinic Info</h4>
							<div class="row form-row">
								<div class="col-md-6">
									<div class="form-group">
										<label>Clinic Name <span class="text-danger">*</span></label>
										<input type="text" class="form-control" th:field="*{clinic.name}" required>
									</div>
								</div>
								<div class="col-md-6">
									<div class="form-group">
										<label>Clinic Specializations <span class="text-danger">*</span></label>
										<input type="text" class="form-control" th:field="*{clinic.specialities}" required>
									</div>
								</div>
								<div class="col-md-6">
									<div class="form-group">
										<label>Address Line 1 <span class="text-danger">*</span></label>
										<input type="text" class="form-control" th:field="*{clinic.addressLine1}" required>
									</div>
								</div>
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label">Address Line 2</label>
										<input type="text" class="form-control" th:field="*{clinic.addressLine2}">
									</div>
								</div>
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label">City <span class="text-danger">*</span></label>
										<input type="text" class="form-control" th:field="*{clinic.city}" required>
									</div>
								</div>

								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label">State / Province <span class="text-danger">*</span></label>
										<input type="text" class="form-control" th:field="*{clinic.state}" required>
									</div>
								</div>
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label">Country <span class="text-danger">*</span></label>
										<input type="text" class="form-control" th:field="*{clinic.country}" required>
									</div>
								</div>
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label">Postal Code</label>
										<input type="text" class="form-control" th:field="*{clinic.postalCode}">
									</div>
								</div>
								<div class="col-md-12">
									<div class="form-group">
										<label class="control-label">Location</label>
										<small class="text-muted font-italic">(Drop the pin where your clinic is located)</small>
										<div id="clinic_location_map"></div>
										<input type="hidden" id="clinicInputLat" th:field="*{clinic.lat}">
										<input type="hidden" id="clinicInputLong" th:field="*{clinic.lng}">
									</div>
								</div>
								<div class="col-md-12">
									<div class="form-group">
										<label>Clinic Images</label>
										<div class="dropzone position-relative">
											<input type="file" th:field="*{clinic.postedImages}" multiple accept=".png,.jpeg,.jpg">
											<div class="dropzone-message display-5 position-absolute">Drop files here to upload</div>
										</div>
									</div>
									<div class="upload-wrap" id="clinicUploadWrap">
										<div class="upload-images uploaded-file" th:each="clinicImg : ${doctor?.clinic?.parsedImages}">
											<img th:src="@{${'/images/' + clinicImg}}" th:attr="data-image=${clinicImg}" alt="Clinic Image">
											<a href="javascript:void(0);" class="btn btn-icon btn-danger btn-sm btn-rm"><i class="far fa-trash-alt"></i></a>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<!-- /Clinic Info -->

					<!-- Services and Specialization -->
					<div class="card services-card">
						<div class="card-body">
							<h4 class="card-title">Services and Specialization</h4>
							<div class="form-group">
								<label>Services</label>
								<select th:field="*{services}" class="form-control services-multiple" multiple="multiple">
									<option th:each="service : ${services}" th:value="${service.id}" th:text="${service.name}"></option>
								</select>
<!--								<small class="form-text text-muted">Note : Type & Press enter to add new services</small>-->
								<p th:if="${#fields.hasErrors('services')}" th:errors="*{services}" class="invalid-feedback"></p>
							</div>
							<div class="form-group mb-0">
								<label>Specialization </label>
								<select th:field="*{specialities}" class="form-control specialities-multiple" multiple="multiple">
									<option th:each="speciality : ${specialities}" th:value="${speciality.id}" th:text="${speciality.name}"></option>
								</select>
<!--								<small class="form-text text-muted">Note : Type & Press  enter to add new specialization</small>-->
								<p th:if="${#fields.hasErrors('specialities')}" th:errors="*{specialities}" class="invalid-feedback"></p>
							</div>
						</div>
					</div>
					<!-- /Services and Specialization -->

					<div class="submit-section submit-btn-bottom">
						<button type="submit" class="btn btn-primary submit-btn">Save Changes</button>
					</div>
					</form>
				</div>
			</div>
			</div>
		</div>
	</div>
	<div layout:fragment="layoutExtra"></div>
	<th:block layout:fragment="customScripts">
		<!-- Circle Progress JS -->
		<script src="/assets/js/circle-progress.min.js"></script>
		<script>
			$(document).ready(function() {
				$('.specialities-multiple').select2();
				$('.services-multiple').select2();
			});
		</script>
		<script src="/assets/js/doctor-clinic.js"></script>
		<script>
			const clinicForm = document.getElementById('doctorProfileForm');
			const clinicFiles = {
				files: [],
				wrap: document.getElementById('clinicUploadWrap'),
				renderPreview() {
					for (let i in this.files) {
						let file = this.files[i];
						let imgUrl = window.URL.createObjectURL(file);

						let imgDelBtn = document.createElement('a');
						imgDelBtn.href = 'javascript:void(0);';
						imgDelBtn.classList.add('btn', 'btn-icon', 'btn-danger', 'btn-sm')
						imgDelBtn.innerHTML = '<i class="far fa-trash-alt"></i>';

						let imgItem = document.createElement('div');
						imgItem.classList.add('upload-images');
						imgItem.innerHTML = `<img src="${imgUrl}" alt="Upload Image">`;
						imgItem.appendChild(imgDelBtn);

						let input = document.createElement('input');
						let container = new DataTransfer();
						container.items.add(file);

						input.name = `clinic.postedImages[${i}]`;
						input.type = 'file';
						input.files = container.files;
						input.classList.add('sr-only', 'sr-only-focusable');

						clinicForm.appendChild(input);

						imgDelBtn.onclick = () => {
							imgItem.remove();
							this.files = this.files.filter((_file) => _file != file)
							clinicForm.querySelector(`input[name="postedImages[${i}]"]`).remove();
						}

						this.wrap.appendChild(imgItem);
					}
				},
			};

			clinicFiles.wrap.querySelectorAll('.uploaded-file').forEach((el) => {
				let removeBtn = el.querySelector('.btn-rm')
				if (removeBtn) {
					removeBtn.onclick = (e) => {
						e.preventDefault();
						el.remove();

						let input = document.createElement('input');
						input.type = 'hidden';
						input.name = 'deletedImages[]';
						input.value = el.querySelector('img').dataset.image;
						clinicForm.appendChild(input);
					}
				}
			})

			document.getElementById('clinic.postedImages').onchange = function() {
				for (let file of this.files) {
					clinicFiles.files.push(file);
				}
				clinicFiles.renderPreview();

				this.value = ''; //reset files
			}
		</script>
	</th:block>
</body>
</html>